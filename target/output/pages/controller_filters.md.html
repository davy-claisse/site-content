<div class="page-header">
<h1>
Controller filters
</h1>
</div>
<p>Controller filters are similar to that of Servlet filters, but designed to wrap execution of controllers. They can be used for many tasks that need to trigger before and after execution of a controller, such as login in, loggin, opening a DB connection, timing, etc. Controller filters are implementation of a <a href="http://en.wikipedia.org/wiki/Chain-of-responsibility_pattern">Chain of responsibility</a> design pattern.</p>
<p>Filters are almost as powerful as controllers. They can inspect any aspects of a request, including request parameters, headers, etc. They can also preempt controllers and send different responses than a controller (think of a permission access filter for example, which will redirect to a login screen in case there is an attempt to access a protected resource).</p>
<p>All filters extends this class:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">package org.javalite.activeweb.controller_filters;</span>
<span class="kw">public</span> <span class="kw">class</span> HttpSupportFilter {
    <span class="dt">void</span> <span class="fu">before</span>(){}
    <span class="dt">void</span> <span class="fu">after</span>(){}
    <span class="dt">void</span> <span class="fu">onException</span>(Exception e){}
}</code></pre></td></tr></table></div>
<h2 id="filter-configuration">Filter configuration</h2>
<p>Configuration of filters is done in a class called <code>app.config.AppControllerConfig</code>, which needs to extend <code>org.javalite.activeweb.AbstractControllerConfig</code>. This class provides ways to bind filters to controllers. It has coarse as well as fine grained grain methods for binding .</p>
<h2 id="filter-ordering">Filter ordering</h2>
<p>Filters follow a so-called The Onion pattern. The <code>before()</code> methods are executed before a controller executer</p>
<blockquote>
<p>The <code>before()</code> methods are executed in the same order as filters are registered.</p>
</blockquote>
<p>The <code>after()</code> methods are executed .. after a controller.</p>
<blockquote>
<p>The <code>after()</code> methods are executed in the opposite order as filters are registered.</p>
</blockquote>
<p>For example, lets say we have the following configuration:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> AppControllerConfig <span class="kw">extends</span> AbstractControllerConfig {
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">init</span>(AppContext appContext) {
        <span class="fu">add</span>(<span class="kw">new</span> <span class="fu">GlobalFilter1</span>(), <span class="kw">new</span> <span class="fu">GlobalFilter2</span>());
        <span class="fu">add</span>(<span class="kw">new</span> <span class="fu">ControllerFilter1</span>(), <span class="kw">new</span> <span class="fu">ControllerFilter2</span>()).<span class="fu">to</span>(DoFiltersController.<span class="fu">class</span>);
    }
}</code></pre></td></tr></table></div>
<p>The order of execution will be:</p>
<div class="sourceCode"><table class="sourceCode numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="sourceCode"><pre><code class="sourceCode">GlobalFilter1#before()
GlobalFilter2#before()
ControllerFilter1#before()
ControllerFilter2#before()
DoFiltersController#index()
ControllerFilter2#after()
ControllerFilter1#after()
GlobalFilter2#after()
GlobalFilter1#after()</code></pre></td></tr></table></div>
<h2 id="filter-interruptions">Filter interruptions</h2>
<p>A filter may interrupt a flow of execution in case where it generates a response to a web client. A classic example is checking authentication filter:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> AuthorizationFilter <span class="kw">extends</span> HttpSupportFilter {
    <span class="fu">@Override</span>
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">before</span>() {
        <span class="kw">if</span>(!<span class="fu">sessionHas</span>(<span class="st">&quot;user&quot;</span>){
            <span class="fu">redirect</span>(LoginController.<span class="fu">class</span>);
        }
    }
}</code></pre></td></tr></table></div>
<p>In this case, if the session has no object called &quot;user&quot;, the filter will redirect to a login controller.</p>
<blockquote>
<p>If a filter generated a response to a controller from the <code>before()</code> method, all following <code>before()</code> methods of downstream filters as well as the target controller are skipped.</p>
</blockquote>
<p>This rule does not affect the <code>after()</code> methods, which will execute in the same order as described above.</p>
<h2 id="adding-global-filters">Adding global filters</h2>
<p>Adding global filter adds the to all controllers. It makes sense to use this feature to add logging, authentication filters, etc.</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> AppControllerConfig <span class="kw">extends</span> AbstractControllerConfig {
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">init</span>(AppContext context) {
    <span class="fu">add</span>(<span class="kw">new</span> <span class="fu">AuthenticationFilter</span>());
  }
}</code></pre></td></tr></table></div>
<p>Not specifying what controller a filter is added to makes it a global filter(will execute fro any controller)</p>
<h2 id="excluding-controllers">Excluding controllers</h2>
<p>In some cases, you need to add filters to all controllers, except a few. For example, you might have a security filter, and there is no point to add it to non-secure controllers, or you have a DBConnectionFilter, and you do not want to open connections for controllers which you know will not use a DB connection (expensive resource). Then you can exclude some controllers from global filters:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> AppControllerConfig <span class="kw">extends</span> AbstractControllerConfig {
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">init</span>(AppContext context) {
    <span class="fu">add</span>(<span class="kw">new</span> <span class="fu">DBConnectionFilter</span>()).<span class="fu">exceptFor</span>(HomeController.<span class="fu">class</span>);
  }
}</code></pre></td></tr></table></div>
<p>The <code>exceptFor()</code> method, takes a vararg, so you can pass multiple controllers there.</p>
<h2 id="adding-filters-to-specific-controllers">Adding filters to specific controllers</h2>
<p>To add filters to specific controllers:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> AppControllerConfig <span class="kw">extends</span> AbstractControllerConfig {
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">init</span>(AppContext context) {
    <span class="fu">add</span>(<span class="kw">new</span> <span class="fu">TimingFilter</span>()).<span class="fu">to</span>(HomeController.<span class="fu">class</span>);
  }
}</code></pre></td></tr></table></div>
<p>Both the <code>add()</code> an the <code>to()</code> methods take in varargs, allowing to bind multiple filters to multiple controllers in one line of code.</p>
<h2 id="adding-filters-to-specific-actions">Adding filters to specific actions</h2>
<p>Here is an example of adding a filter to specific actions:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> AppControllerConfig <span class="kw">extends</span> AbstractControllerConfig {
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">init</span>(AppContext context) {
    <span class="fu">add</span>(<span class="kw">new</span> <span class="fu">TimingFilter</span>(), <span class="kw">new</span> <span class="fu">DBConnectionFilter</span>()).<span class="fu">to</span>(PostsController.<span class="fu">class</span>).<span class="fu">forActions</span>(<span class="st">&quot;index&quot;</span>, <span class="st">&quot;show&quot;</span>);
  }
}</code></pre></td></tr></table></div>
<h2 id="exception-handling">Exception handling</h2>
<p>The <code>void onException(Exception e);</code> method can be used to handle exceptions occurred during execution of a controller of other (inner) filters. It is typical on a project to register a &quot;catch all filter&quot; as a global top-most filter. You probably saw default error page coming from the application server in cases when there is a failure in the application. If you declare a &quot;catch all &quot; filter, this can be avoided, and users would see a friendly page with a message.</p>
<p>Here is an example:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> CatchAllFilter <span class="kw">extends</span> HttpSupportFilter {
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onException</span>(Exception e) {
        <span class="fu">logError</span>(e.<span class="fu">toString</span>(), e);
        <span class="fu">render</span>(<span class="st">&quot;/system/error&quot;</span>, Collections.<span class="fu">map</span>(<span class="st">&quot;message&quot;</span>, <span class="st">&quot;Apologies for inconvenience&quot;</span>);
    }
}</code></pre></td></tr></table></div>
<p>In the code snippet above, the <code>CatchAllFilter</code> will be given a chance to log an exception to a log system, but then also to display a friendly styled error page in default layout.</p>
<h2 id="out-of-the-box-filters">Out of the box filters</h2>
<p>ActiveWeb provides a number of filters for easy configuration of projects.</p>
<h3 id="dbconnectionfilter">DBConnectionFilter</h3>
<p><code>DBConnectionFilter</code> opens a connection before execution of a controller and closes it after execution. Here is an example of usage of this filter from the <a href="https://github.com/javalite/kitchensink">Kitchensink</a> project:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> AppControllerConfig <span class="kw">extends</span> AbstractControllerConfig {
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">init</span>(AppContext context) {
        <span class="fu">add</span>(<span class="kw">new</span> <span class="fu">DBConnectionFilter</span>()).<span class="fu">to</span>(PostsController.<span class="fu">class</span>, RpostsController.<span class="fu">class</span>);
    }
}</code></pre></td></tr></table></div>
<blockquote>
<p><code>DBConnectionFilter</code> works with connections configured in <a href="database_configuration">Database configuration</a>.</p>
</blockquote>
<p>In the example above, the filter is attached only to controllers PostsController and RpostsController. Presumably other controllers do not require a DB connection. If you use <a href="activejdbc">ActiveJDBC</a> for persistence layer, you do not need to do anything else. If you just want to get access to the underlying DB connection, you can do this inside a controller or inner filter:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode java">java.<span class="fu">sql</span>.<span class="fu">Connection</span> connection = Base.<span class="fu">connection</span>();</code></pre></td></tr></table></div>
<p>which gives you a full control over this connection.</p>
<h3 id="requestpropertieslogfilter">RequestPropertiesLogFilter</h3>
<p>This filter will log properties of a request to a log system. It is useful for debugging. Example output of this filter:</p>
<pre class="prettyprint"><code>32644 [2132827533@qtp-1457284258-0] INFO org.javalite.activeweb.controller_filters.RequestPropertiesLogFilter -
Request URL: http://localhost:8080/kitchensink/
ContextPath: /kitchensink
Query String: null
URI Full Path: /kitchensink/
URI Path: /
Method: GET</code></pre>
<h3 id="requestparamslogfilter">RequestParamsLogFilter</h3>
<p>This filter will log parameters of the request, here is an example:</p>
<pre class="prettyprint"><code>176575 [2090322800@qtp-1699024671-2] INFO org.javalite.activeweb.controller_filters.RequestParamsLogFilter -
Param: content=content to be determined...
Param: id=3
Param: author=Igor Polevoy
Param: title=What good for Ruby is good for Java: JSpec</code></pre>
<h3 id="headerslogfilter">HeadersLogFilter</h3>
<p>This filter will dump all HTTP request headers:</p>
<pre class="prettyprint"><code>176576 [2090322800@qtp-1699024671-2] INFO org.javalite.activeweb.controller_filters.HeadersLogFilter -
Header: Accept-Language=en-us,en;q=0.5
Header: Cookie=JSESSIONID=6trloxem6xib; remember_me=3f654b9f-8abd-4693-bf62-43ccc7c6
Header: Host=localhost:8080
Header: Content-Length=106
Header: Accept-Charset=ISO-8859-1,utf-8;q=0.7,*;q=0.7
Header: Referer=http://localhost:8080/kitchensink/posts/edit_post/3
Header: Accept-Encoding=gzip,deflate
Header: Keep-Alive=115
Header: User-Agent=Mozilla/5.0 (X11; U; Linux x86_64; en-US; rv:1.9.2.16) Gecko/20110323 Ubuntu/10.10 (maverick) Firefox/3.6.16
Header: Content-Type=application/x-www-form-urlencoded
Header: Connection=keep-alive
Header: Accept=text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</code></pre>
<h3 id="changing-log-levels">Changing log levels</h3>
<p>You can add a filter to AppContext before registration:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> AppControllerConfig <span class="kw">extends</span> AbstractControllerConfig {
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">init</span>(AppContext context) {
        HeadersLogFilter headersLogger = <span class="kw">new</span> <span class="fu">HeadersLogFilter</span>();
        context.<span class="fu">set</span>(<span class="st">&quot;headersLogger&quot;</span>, headersLogger);
        <span class="fu">add</span>(<span class="kw">new</span> <span class="fu">TimingFilter</span>(), <span class="kw">new</span> <span class="fu">RequestPropertiesLogFilter</span>(), <span class="kw">new</span> <span class="fu">RequestParamsLogFilter</span>(),
                headersLogger);
    }
}</code></pre></td></tr></table></div>
<p>This will ensure that you can get to these filters from controller later on:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> AdminController <span class="kw">extends</span> AppController {
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setHeadersLogLevel</span>(){
        <span class="co">//how to disable logging of headers at run time:</span>
        <span class="fu">appContext</span>().<span class="fu">get</span>(<span class="st">&quot;headersLogger&quot;</span>, HeadersLogFilter.<span class="fu">class</span>).<span class="fu">logAtLevel</span>(Level.<span class="fu">valueOf</span>(<span class="fu">param</span>(<span class="st">&quot;log_level&quot;</span>)));
    }
}</code></pre></td></tr></table></div>
<p>Moving log level of these filters above or below current log system log level is easy and very useful. In production you might want to have these at INFO level, but you might want to temporarily enable DEBUG logging to trace some problem, then turn it off again, all without having to redeploy or restart a server.</p>
