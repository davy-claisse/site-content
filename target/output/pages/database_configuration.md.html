<div class="page-header">
<h1>
Database configuration
</h1>
</div>
<p>ActiveWeb uses two application classes for configuration:</p>
<ul>
<li><code>app.config.DbConfig</code> - allows to configure connections for different environments.</li>
<li><code>app.config.AppControllerConfig</code> - allows configuration of <code>DBConnectionFilter</code> instances to various controllers. See <a href="#bind-connections-to-controllers">Bind connections to controllers</a></li>
</ul>
<p>In order to configure database connection, an application needs to provide a class called <code>app.config.DbConfig</code>. It is used to configure database connections for various <strong>environments and modes</strong>.</p>
<h2 id="what-is-an-environment">What is an environment?</h2>
<p>An ActiveWeb environment is a computer where a project executes. In the process of software development there can be a number of environments where a project gets executed, such as development, continuous integration, QA, staging, production and more. The number of environments for ActiveWeb is custom for every project. However, it is typical to have four: development, continuous integration, staging and production</p>
<h2 id="how-to-specify-an-environment">How to specify an environment</h2>
<p>An environment is specified by either:</p>
<ul>
<li>Environment variable: <code>ACTIVE_ENV</code></li>
<li>Java System property: <code>active_env</code></li>
</ul>
<blockquote>
<p>If both, environment variable and a system property are specified, then system property overrides environment variable.</p>
</blockquote>
<p>This value is used to determine which DB connections need to be initialized.</p>
<blockquote>
<p>Default environment: In case an environment variable <code>ACTIVE_ENV</code> is not provided, the framework defaults to &quot;development&quot;.</p>
</blockquote>
<h2 id="execution-modes">Execution modes</h2>
<p>ActiveWeb defines two modes of operation:</p>
<ul>
<li>&quot;standard&quot; - is also implicit and default. Used during regular execution of applications</li>
<li>&quot;testing&quot; - used during the build when tests are executed</li>
</ul>
<p>ActiveWeb promotes a style of development where one database used for testing, but a different one used under normal execution. When tests are executed, a &quot;test&quot; database is used, and when a project is run in a normal mode, a &quot;development&quot; database is used. Having sa separate database for testing ensures safety of data in the development database.</p>
<h2 id="configure-connections">Configure connections</h2>
<p>There are two basic ways to configure connections: property file and in code. You can also use a mixed approach, where connections are configured in a property file, and in code. Please, see section &quot;Property file configuration&quot; below.</p>
<h3 id="property-file-configuration">Property file configuration</h3>
<p>You can create a file called <code>database.properties</code> and place it on classpath or somewhere on the file system.</p>
<p>The content of the file can be similar to:</p>
<div class="sourceCode"><table class="sourceCode numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="sourceCode"><pre><code class="sourceCode">development.driver=com.mysql.jdbc.Driver
development.username=root
development.password=pwd1
development.url=jdbc:mysql://localhost/simple_development

development.test.driver=com.mysql.jdbc.Driver
develppment.test.username=root
development.test.password=pwd2
development.test.url=jdbc:mysql://localhost/simple_test

jenkins.test.driver=com.mysql.jdbc.Driver
jenkins.test.username=root
jenkins.test.password=pwd2
jenkins.test.url=jdbc:mysql://jenkins.myhost.com/simple_test

production.driver=com.mysql.jdbc.Driver
production.username=root
production.password=pwd2
production.url=jdbc:mysql://localhost/simple_test</code></pre></td></tr></table></div>
<p>The configure the class <code>app.config.DbConfig</code>:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> DbConfig <span class="kw">extends</span> AbstractDBConfig {
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">init</span>(AppContext context) {
        <span class="fu">configFile</span>(<span class="st">&quot;/database.properties&quot;</span>);
        <span class="fu">environment</span>(<span class="st">&quot;production&quot;</span>, <span class="kw">true</span>).<span class="fu">jndi</span>(<span class="st">&quot;jdbc/simple_production&quot;</span>);        
    }
}</code></pre></td></tr></table></div>
<p>The property file configuration works well with <a href="database_migrations">Database Migration</a> system, so that configuration of database connections is done only in one place.</p>
<p>The last line in <code>app.config.DbConfig</code> overrides &quot;production&quot; configuration from the file. The &quot;production&quot; configuration in the file can be used by <a href="database_migrations">Database Migrator</a>, while the app itself will be using a connection from a pool provided by container.</p>
<blockquote>
<p>File-based configuration allows only one database connection configuration per environment.</p>
</blockquote>
<p>Please, see a working example of file based configuration in the <a href="https://github.com/javalite/activeweb-simple/">ActiveWeb Simple</a> project.</p>
<h3 id="java-code-configuration">Java code configuration</h3>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> DbConfig <span class="kw">extends</span> AbstractDBConfig {
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">init</span>(AppContext context) {
         <span class="fu">environment</span>(<span class="st">&quot;development&quot;</span>).<span class="fu">jndi</span>(<span class="st">&quot;jdbc/kitchensink_development&quot;</span>);
         <span class="fu">environment</span>(<span class="st">&quot;development&quot;</span>).<span class="fu">testing</span>().<span class="fu">jdbc</span>(<span class="st">&quot;com.mysql.jdbc.Driver&quot;</span>, <span class="st">&quot;jdbc:mysql://localhost/kitchensink_development&quot;</span>, <span class="st">&quot;root&quot;</span>, <span class="st">&quot;****&quot;</span>);
         <span class="fu">environment</span>(<span class="st">&quot;jenkins&quot;</span>).<span class="fu">testing</span>().<span class="fu">jdbc</span>(<span class="st">&quot;com.mysql.jdbc.Driver&quot;</span>, <span class="st">&quot;jdbc:mysql://172.30.64.31/kitchensink_jenkins&quot;</span>, <span class="st">&quot;root&quot;</span>, <span class="st">&quot;****&quot;</span>);
         <span class="fu">environment</span>(<span class="st">&quot;production&quot;</span>).<span class="fu">jndi</span>(<span class="st">&quot;java:comp/env/jdbc/myproject_production);</span>
    }
}</code></pre></td></tr></table></div>
<p>The code above is borrowed from <a href="https://github.com/javalite/kitchensink">Kitchensink</a> project. Lets examine it line by line.</p>
<ul>
<li><strong>Line 3</strong>: here we provide configuration for a &quot;standard&quot; mode in &quot;development&quot; environment. This DB connection will be used when the application is running under normal conditions in development environment.</li>
<li><strong>Line 4</strong>: This is a configuration of DB connection for &quot;development&quot; environment, but for &quot;testing&quot; mode. This connection will be used by unit and integration tests during the build.</li>
<li><strong>Line 5</strong>: This is a configuration of DB connection for &quot;jenkins&quot; environment, but for &quot;testing&quot; mode. The &quot;jenkins&quot; environment is a computer where this project is built by Jenkins - the continuous integration server. Since Jenkins computer is fully automated, and this project is not running there in &quot;standard&quot; mode, there is no standard configuration for jenkins environment, just one for testing.</li>
<li><strong>Line 6</strong>: This is configuration similar to one on line 3, but for &quot;production&quot; environment.</li>
</ul>
<blockquote>
<p>Configuration of database connections is just that - configuration. This code only configures a connection, but does not open it. To open a connection, you need to use <a href="https://github.com/javalite/activeweb/blob/master/activeweb/src/main/java/org/javalite/activeweb/controller_filters/DBConnectionFilter.java#DBConnectionFilter">DBConnectionFilter</a>. For more, see <a href="controller_filters">Controller filters</a>.</p>
</blockquote>
<h3 id="multiple-db-connections">Multiple DB connections</h3>
<p>In some cases you will need to connect to more than one database. The class <code>DbConfig</code> can be used to configure multiple connections in the same environment:</p>
<p>Code configuration:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> DbConfig <span class="kw">extends</span> AbstractDBConfig {
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">init</span>(AppContext context) {
         <span class="co">// default DB:</span>
         <span class="fu">environment</span>(<span class="st">&quot;production&quot;</span>, <span class="kw">true</span>).<span class="fu">jndi</span>(<span class="st">&quot;java:comp/env/jdbc/myproject_production1); </span>
         <span class="co">// named DB:</span>
         <span class="fu">environment</span>(<span class="st">&quot;production&quot;</span>, <span class="kw">false</span>).<span class="fu">db</span>(<span class="st">&quot;prod2&quot;</span>).<span class="fu">jndi</span>(<span class="st">&quot;java:comp/env/jdbc/myproject_production2);</span>
    }
}</code></pre></td></tr></table></div>
<p>Two different databases are configured for environment 'production'. A corresponding binding of two instances if <code>DBConnectionFilter</code> will look like this:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> AppControllerConfig <span class="kw">extends</span> AbstractControllerConfig {
  <span class="fu">@Override</span>
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">init</span>(AppContext context) {
      <span class="fu">add</span>(<span class="kw">new</span> <span class="fu">DBConnectionFilter</span>(<span class="st">&quot;default&quot;</span>, <span class="kw">true</span>), <span class="kw">new</span> <span class="fu">DBConnectionFilter</span>(<span class="st">&quot;prod2&quot;</span>, <span class="kw">true</span>));
  }
}</code></pre></td></tr></table></div>
<p>Binding of two instances of <code>DBConnectionFilter</code> class will ensure opening and closing connections to corresponding databases before/after execution of controllers as specified in the <code>DbConfig</code> above.</p>
<p>Additionally, if you do not need the second connection on all controllers, then your configuration might like this:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> AppControllerConfig <span class="kw">extends</span> AbstractControllerConfig {
  <span class="fu">@Override</span>
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">init</span>(AppContext context) {
      <span class="fu">add</span>(<span class="kw">new</span> <span class="fu">DBConnectionFilter</span>(<span class="st">&quot;default&quot;</span>, <span class="kw">true</span>));
      <span class="fu">add</span>(<span class="kw">new</span> <span class="fu">DBConnectionFilter</span>(<span class="st">&quot;prod2&quot;</span>, <span class="kw">true</span>)).<span class="fu">to</span>(MySpecialController.<span class="fu">class</span>);
  }
}</code></pre></td></tr></table></div>
<p>This way, the connection to <code>prod2</code> will be opened only for execution of <code>MySpecialController</code>.</p>
<h3 id="different-connections-for-controllers">Different connections for controllers</h3>
<p>If you need to use different connectios for different controllers, you have to define your named connections to databases in the DBConfig class:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> DbConfig <span class="kw">extends</span> AbstractDBConfig {
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">init</span>(AppContext context) {
         <span class="fu">environment</span>(<span class="st">&quot;production&quot;</span>, <span class="kw">true</span>).<span class="fu">db</span>(<span class="st">&quot;apples&quot;</span>).<span class="fu">jndi</span>(<span class="st">&quot;java:comp/env/jdbc/apples_db; </span>
         <span class="fu">environment</span>(<span class="st">&quot;production&quot;</span>, <span class="kw">true</span>).<span class="fu">db</span>(<span class="st">&quot;oranges&quot;</span>).<span class="fu">jndi</span>(<span class="st">&quot;java:comp/env/jdbc/oranges_db);</span>
    }
}</code></pre></td></tr></table></div>
<p>Remember, that this is just configurations. The class <code>DbConfig</code> does not open any connections. Opening connections is a responsibility of <code>DBConnectionFilter</code> class:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> AppControllerConfig <span class="kw">extends</span> AbstractControllerConfig {
  <span class="fu">@Override</span>
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">init</span>(AppContext context) {
      <span class="fu">add</span>(<span class="kw">new</span> <span class="fu">DBConnectionFilter</span>(<span class="st">&quot;default&quot;</span>, <span class="kw">true</span>));
      <span class="fu">add</span>(<span class="kw">new</span> <span class="fu">DBConnectionFilter</span>(<span class="st">&quot;apples&quot;</span>, <span class="kw">true</span>)).<span class="fu">to</span>(ApplesController.<span class="fu">class</span>);
      <span class="fu">add</span>(<span class="kw">new</span> <span class="fu">DBConnectionFilter</span>(<span class="st">&quot;oranges&quot;</span>, <span class="kw">true</span>)).<span class="fu">to</span>(OrangesController.<span class="fu">class</span>);
  }
}</code></pre></td></tr></table></div>
<p><strong>NOTE:</strong> in this case, you will have different named databases on current thread. This means that the models executed in the <code>ApplesController</code> should be tagged with <code>apples</code> dababase name:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="fu">@DbName</span>(<span class="st">&quot;apples&quot;</span>)
<span class="kw">public</span> <span class="kw">class</span> Apple <span class="kw">extends</span> Model{}</code></pre></td></tr></table></div>
<p>If not, you will get a &quot;connection not found&quot; exception.</p>
<h3 id="go-crazy-with-connections">Go crazy with connections</h3>
<p>If you need a very complex logic opening different connections for different conditions, you may need to implement your own controller filter. Remember, that the <code>DBConnectionFilter</code> is just ... another ActiveWeb filter. Take a look at implementation: <a href="https://github.com/javalite/activeweb/blob/master/activeweb/src/main/java/org/javalite/activeweb/controller_filters/DBConnectionFilter.java">DBConnectionFilter</a>.</p>
<p>All you need is to open your connection with <code>Base.open()</code> od <code>DB.open()</code> in the <code>before()</code> method, close it in <code>after()</code> method and do what you have to in <code>onException(e)</code> method.</p>
<h2 id="bind-connections-to-controllers">Bind Connections to controllers</h2>
<p>Binding connections to controllers is done with <code>DBConnectionFilter</code> in <code>AppControllerConfig</code> class. Here is a typical example:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> AppControllerConfig <span class="kw">extends</span> AbstractControllerConfig {
  <span class="fu">@Override</span>
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">init</span>(AppContext context) {
      <span class="fu">add</span>(<span class="kw">new</span> <span class="fu">DBConnectionFilter</span>(<span class="st">&quot;default&quot;</span>, <span class="kw">true</span>));
  }
}</code></pre></td></tr></table></div>
<p>Binding above will open a &quot;default&quot; database connection before execution of any controller. If this is too crude, you can open connections for specific controllers:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> AppControllerConfig <span class="kw">extends</span> AbstractControllerConfig {
    <span class="fu">@Override</span>
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">init</span>(AppContext context) {
       <span class="fu">add</span>(<span class="kw">new</span> <span class="fu">DBConnectionFilter</span>(<span class="st">&quot;default&quot;</span>, <span class="kw">true</span>)).<span class="fu">to</span>(
       MyPrivateController1.<span class="fu">class</span>,MyPrivateController2.<span class="fu">class</span>,
       MyPrivateController3.<span class="fu">class</span>,MyPrivateController4.<span class="fu">class</span>
       );
    }
}</code></pre></td></tr></table></div>
<p>You can configure a fine-grain binding to a specific action:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> AppControllerConfig <span class="kw">extends</span> AbstractControllerConfig {
    <span class="fu">@Override</span>
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">init</span>(AppContext context) {
        <span class="fu">add</span>(<span class="kw">new</span> <span class="fu">DBConnectionFilter</span>(<span class="st">&quot;default&quot;</span>, <span class="kw">true</span>)).<span class="fu">to</span>(MyPrivateController1.<span class="fu">class</span>).<span class="fu">forActions</span>(<span class="st">&quot;index&quot;</span>);
    }
}</code></pre></td></tr></table></div>
<h2 id="tying-it-all-together">Tying it all together</h2>
<p>The <a href="https://github.com/javalite/activeweb-simple/">ActiveWeb Simple</a> is one example of full configuration:</p>
<ul>
<li>Property file: <a href="https://github.com/javalite/activeweb-simple/blob/master/src/main/resources/database.properties">database.properties</a></li>
<li><a href="https://github.com/javalite/activeweb-simple/blob/master/src/main/java/app/config/DbConfig.java">DBConfig</a> - configure connections</li>
<li><a href="https://github.com/javalite/activeweb-simple/blob/master/src/main/java/app/config/AppControllerConfig.java">AppControllerConfig</a> - bind connections to controllers</li>
<li>DB-Migrator configuration: <a href="https://github.com/javalite/activeweb-simple/blob/master/pom.xml#L35">pom.xml</a> - to configure <a href="database_migrations">DB-Migrator</a>.</li>
</ul>
<h2 id="running-without-a-database">Running without a database</h2>
<p>If you need a simle site that does not require a database or you are using a different type of a backend, you can simply delete the class <code>app.config.DbConfig</code> from your project. When the framework starts, it will detect the absense of this class, will print a warning, but will operate without issues.</p>
<p>In adition to that, remove usage of <code>org.javalite.activeweb.controller_filters.DBConnectionFilter</code> or your custom filter from class <code>app.config.AppControllerConfig</code>.</p>
