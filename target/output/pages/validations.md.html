<div class="page-header">
<h1>
Validations
</h1>
</div>
<p>ActiveJDBC has a validation framework that is somewhat reminiscent of ActiveRecord validation. The validation rules in ActiveJDBC are described in a model definition in a declarative way.</p>
<h2 id="validation-of-attribute-presence">Validation of attribute presence</h2>
<p>In order to add any validation, a model will declare a static bloc at the top of a class definition, and invoke all validation declaration inside this block:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Person <span class="kw">extends</span> Model {
    <span class="dt">static</span>{
        <span class="fu">validatePresenceOf</span>(<span class="st">&quot;first_name&quot;</span>, <span class="st">&quot;last_name&quot;</span>);
    }    
}</code></pre></td></tr></table></div>
<p>The method <code>Model.validatePresenceOf()</code> takes a vararg of strings, which allows to specify a list of attribute names (column names) in one line of code.</p>
<h2 id="triggering-of-validation">Triggering of validation</h2>
<p>triggering of validations causes these actions:</p>
<ul>
<li>Call <code>Model.validate()</code> method (will not throw exception)</li>
<li>Call <code>Model.save()</code> method (will not throw exception)</li>
<li>Call <code>Model.saveIt()</code> method (will throw exception)</li>
<li>Call <code>Model.createIt()</code> method (will throw exception)</li>
</ul>
<p>The semantic difference of <code>save()</code> and <code>saveIt()</code> methods is described on the <a href="record_creation">Record creation</a> page.</p>
<h2 id="consuming-validation-messages">Consuming validation messages</h2>
<p>After the validation triggered, you can retrieve all messages from a model as a collection:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="co">//...trigger validation</span>

Map&lt;String, String&gt; errors = myPerson.<span class="fu">errors</span>();
String firstNameError = errors.<span class="fu">get</span>(<span class="st">&quot;first_name&quot;</span>);</code></pre></td></tr></table></div>
<p>As you can imagine, it is very easy to write web applications with form validation using this ActiveJDBC.</p>
<h2 id="usage-in-a-web-application">Usage in a web application</h2>
<p>This is a pseudo-code of a web application controller where a form was submitted:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="sourceCode"><pre><code class="sourceCode java">
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">doPost</span>(...){
   Map params = <span class="kw">... </span><span class="co">// this is a map of HTML form submitted from a web page</span>
   Person p = <span class="fu">Person</span>();
   p.<span class="fu">fromMap</span>(params); <span class="co">//The model will only pluck values that correspond to it&#39;s attribute names</span>
   
   <span class="kw">if</span>(p.<span class="fu">save</span>()){
      <span class="co">//render success page</span>
   }<span class="kw">else</span>{
      request.<span class="fu">setAttribute</span>(<span class="st">&quot;errors&quot;</span>, p.<span class="fu">errors</span>());
      <span class="fu">getServletContext</span>().<span class="fu">getRequestDispatcher</span>(<span class="st">&quot;/results.jsp&quot;</span>).<span class="fu">forward</span>(request,response);
   }
}</code></pre></td></tr></table></div>
<p>In a JSP:</p>
<div class="sourceCode"><table class="sourceCode html numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode html">
<span class="kw">&lt;span</span><span class="ot"> style=</span><span class="st">&quot;error&quot;</span><span class="kw">&gt;</span>${errors.first_name}<span class="kw">&lt;/span&gt;</span>
...
<span class="kw">&lt;span</span><span class="ot"> style=</span><span class="st">&quot;error&quot;</span><span class="kw">&gt;</span>${errors.last_name}<span class="kw">&lt;/span&gt;</span>
...</code></pre></td></tr></table></div>
<p>In <a href="activeweb">ActiveWeb</a>:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="fu">@POST</span>
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">create</span>(){
    Book book = <span class="kw">new</span> Book();
    book.<span class="fu">fromMap</span>(<span class="fu">params1st</span>());
    <span class="kw">if</span>(!book.<span class="fu">save</span>()){
        <span class="fu">flash</span>(<span class="st">&quot;message&quot;</span>, <span class="st">&quot;Something went wrong, please  fill out all fields&quot;</span>);
        <span class="fu">flash</span>(<span class="st">&quot;errors&quot;</span>, book.<span class="fu">errors</span>());
        <span class="fu">flash</span>(<span class="st">&quot;params&quot;</span>, <span class="fu">params1st</span>());
        <span class="fu">redirect</span>(BooksController.<span class="fu">class</span>, <span class="st">&quot;new_form&quot;</span>);
    }<span class="kw">else</span>{
        <span class="fu">flash</span>(<span class="st">&quot;message&quot;</span>, <span class="st">&quot;New book was added: &quot;</span> + book.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>));
        <span class="fu">redirect</span>(BooksController.<span class="fu">class</span>);
    }
}</code></pre></td></tr></table></div>
<p>Here is a link to controller: <a href="https://github.com/javalite/activeweb-simple/blob/master/src/main/java/app/controllers/BooksController.java#L45">ActiveWeb BookController</a></p>
<h2 id="customized-messages-for-different-attributes">Customized messages for different attributes</h2>
<p>You can call method <code>validatePresenceOf().message()</code> multiple times, providing different attribute names as well as different messages:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Person <span class="kw">extends</span> Model {
    <span class="dt">static</span>{
        <span class="fu">validatePresenceOf</span>(<span class="st">&quot;first_name&quot;</span>).<span class="fu">message</span>(<span class="st">&quot;Please, provide your first name&quot;</span>);
        <span class="fu">validatePresenceOf</span>(<span class="st">&quot;last_name&quot;</span>).<span class="fu">message</span>(<span class="st">&quot;Please, provide your last name&quot;</span>);
    }    
}</code></pre></td></tr></table></div>
<h2 id="validation-of-numericality">Validation of numericality</h2>
<p>ActiveJDBC like ActiveRecord also provides other validators, for instance:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Account <span class="kw">extends</span> Model {
    <span class="dt">static</span>{
        <span class="fu">validateNumericalityOf</span>(<span class="st">&quot;amount&quot;</span>, <span class="st">&quot;account&quot;</span>, <span class="st">&quot;total&quot;</span>);
    }
}</code></pre></td></tr></table></div>
<p>Like the <code>validatePresenseOf()</code>, this method also takes in a vararg of strings, which allows to specify a list of attribute names that should have a numeric format.</p>
<h2 id="validation-of-numericality-with-additional-properties">Validation of numericality with additional properties</h2>
<p>When checking numericality of an attribute, you can have a finer control, including specifying that it could be <code>null</code>, providing a range and a custom message. In fact, all validators allow for custom message.</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Account <span class="kw">extends</span> Model {
    <span class="dt">static</span>{
        <span class="fu">validateNumericalityOf</span>(<span class="st">&quot;total&quot;</span>)
                .<span class="fu">allowNull</span>(<span class="kw">true</span>).<span class="fu">greaterThan</span>(<span class="dv">0</span>)
                .<span class="fu">lessThan</span>(<span class="dv">100</span>).<span class="fu">onlyInteger</span>()
                .<span class="fu">message</span>(<span class="st">&quot;incorrect &#39;total&#39;&quot;</span>);
    }
}</code></pre></td></tr></table></div>
<p>Again, ActiveJDBC is using <a href="http://martinfowler.com/bliki/FluentInterface.html">Fluent Interfaces</a> technique, as in many other places.</p>
<h2 id="range-validator">Range validator</h2>
<p>Besides numeric validation, there is also a specific range validator:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Temperature <span class="kw">extends</span> Model {
    <span class="dt">static</span>{
        <span class="dt">int</span> min = <span class="dv">0</span>, max = <span class="dv">100</span>;
        <span class="fu">validateRange</span>(<span class="st">&quot;temp&quot;</span>, min, max).<span class="fu">message</span>(<span class="st">&quot;temperature cannot be less than &quot;</span> + min + <span class="st">&quot; or more than &quot;</span> + max);
    }
}</code></pre></td></tr></table></div>
<p>Although you can use either numeric or range validators for range, in some cases range validator will have a more concise syntax than numeric one.</p>
<h2 id="email-validator">Email validator</h2>
<p>The email validator exists to check a proper format of email (it does not check if email actually exists!)</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> User <span class="kw">extends</span> Model {
    <span class="dt">static</span>{
        <span class="fu">validateEmailOf</span>(<span class="st">&quot;email&quot;</span>);
    }
}</code></pre></td></tr></table></div>
<h2 id="regular-expressions-validator">Regular expressions validator</h2>
<p>You can probably guess, that the email validator is a special case of a regular expression validator:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> User <span class="kw">extends</span> Model {
    <span class="dt">static</span>{
        <span class="fu">validateRegexpOf</span>(<span class="st">&quot;email&quot;</span>, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">b[A-Z0-9._%+-]+@[A-Z0-9.-]+</span><span class="ch">\\</span><span class="st">.[A-Z]{2,4}</span><span class="ch">\\</span><span class="st">b&quot;</span>);
    }
}</code></pre></td></tr></table></div>
<p>This validator provides enough freedom to developers who know regular expressions well :)</p>
<h2 id="custom-validators">Custom validators</h2>
<p>If all else fails, and ActiveJDBC does not provide a validator you want, you can extend a ValidatorAdapter class:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">interface</span> Validator {
    <span class="dt">void</span> <span class="fu">validate</span>(Model m);
    <span class="dt">void</span> <span class="fu">setMessage</span>(String message);
    String <span class="fu">formatMessage</span>(Locale locale, Object <span class="kw">... </span>params);
}</code></pre></td></tr></table></div>
<p>or better yet, <a href="http://javalite.github.io/activejdbc/snapshot/org/javalite/activejdbc/validation/ValidatorAdapter.html">ValidatorAdapter</a>:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> CustomValidator <span class="kw">extends</span> ValidatorAdapter{
   <span class="dt">void</span> <span class="fu">validate</span>(Model m){
       <span class="dt">boolean</span> valid = <span class="kw">true</span>;
      <span class="co">//perform whatever validation logic, then add errors to model if validation did not pass:</span>
      <span class="kw">if</span>(!valid)
         m.<span class="fu">addValidator</span>(<span class="kw">this</span>, <span class="st">&quot;custom_error&quot;</span>);
    }
}</code></pre></td></tr></table></div>
<p>Once you have a custom validation, you can register it with a model like this:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Person <span class="kw">extends</span> Model{
   <span class="dt">static</span>{
      <span class="fu">validateWith</span>(<span class="kw">new</span> <span class="fu">CustomValidator</span>()).<span class="fu">message</span>(<span class="st">&quot;custom.message&quot;</span>);
   }
}</code></pre></td></tr></table></div>
<p>Another way to register is outside your model class:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode java">CustomValidator cv = <span class="kw">new</span> <span class="fu">CustomValidator</span>();
Person.<span class="fu">addValidator</span>(cv).<span class="fu">message</span>(<span class="st">&quot;blah, blah&quot;</span>);</code></pre></td></tr></table></div>
<p>after a validation, you can retrieve an error like this:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
</pre></td><td class="sourceCode"><pre><code class="sourceCode java">Person p = ...
p.<span class="fu">save</span>();
String errorMessage = p.<span class="fu">errors</span>().<span class="fu">get</span>(<span class="st">&quot;custom_error&quot;</span>);</code></pre></td></tr></table></div>
<p>Validators are executed during validation in the order they were added to the model. The <code>validate()</code> method is called from <code>save()</code> and <code>saveIt()</code></p>
<h2 id="customization-of-messages">Customization of messages</h2>
<p>ActiveJDBC provides stock messages (one for each validator), which may not be appropriate for all projects. For instance, <code>validatePresenseOf()</code> provides a simple message &quot;value is missing&quot;. In order to customize these messages, the framework provides a DSL-ish like facility:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Person <span class="kw">extends</span> Model {
    <span class="dt">static</span>{
        <span class="fu">validatePresenceOf</span>(<span class="st">&quot;first_name&quot;</span>, <span class="st">&quot;last_name&quot;</span>).<span class="fu">message</span>(<span class="st">&quot;name.missing&quot;</span>);
    }    
}</code></pre></td></tr></table></div>
<p>where <code>name.missing</code> is a key from a resource bundle <code>activejdbc_messages</code>.</p>
<p>After a validation process, if there are errors, they are accessible via the <code>p.errors()</code> method, and a specific validation error message is accessed using an attribute name as a message key:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode java">String firstNameMissingErrorMessage = p.<span class="fu">errors</span>().<span class="fu">get</span>(<span class="st">&quot;first_name&quot;</span>);</code></pre></td></tr></table></div>
<p>..or you can use the <code>Errors</code> object returned from <code>errors()</code> method as a <code>Map</code> and process it generically (as is usually the case for web applications).</p>
<h2 id="parametric-validation-messages">Parametric validation messages</h2>
<p>In some cases, you will need to parametrize messages coming from a resource bundle. For instance, in a file <code>activejdbc_messages.properties</code> you would have an entry:</p>
<pre class="prettyprint"><code>temperature.outside.limits = Temperature is outside acceptable limits, while it needs to be between {0} and {1}</code></pre>
<p>You might have a model defined like this:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Temperature <span class="kw">extends</span> Model{
   <span class="dt">static</span>{
      <span class="fu">validateRange</span>(<span class="st">&quot;temp&quot;</span>, <span class="dv">10</span>, <span class="dv">2000</span>).<span class="fu">message</span>(<span class="st">&quot;temperature.outside.limits&quot;</span>);
   }
}</code></pre></td></tr></table></div>
<p>You will then create an instance of Temperature, set the values and validate in a code pattern similar to this;</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode java">Temperature temp = <span class="kw">new</span> <span class="fu">Temperature</span>();
temp.<span class="fu">set</span>(<span class="st">&quot;temp&quot;</span>, <span class="dv">5000</span>);

<span class="kw">if</span>(!temp.<span class="fu">save</span>()){
   String message = temp.<span class="fu">errors</span>().<span class="fu">get</span>(<span class="st">&quot;temp&quot;</span>);
   System.<span class="fu">out</span>.<span class="fu">println</span>(message);<span class="co">// prints: Temperature is outside acceptable limits, while it needs to be between 10 and 2000</span>
}</code></pre></td></tr></table></div>
<h2 id="split-parameters-for-validation-messages">Split parameters for validation messages</h2>
<p>In some cases you know parameter values when declaring a model, but some other parameters are only known in the context where validation is actually used. In this case, you can split parameters between the declaration (static context) and calling for messages (dynamic context).</p>
<p>Resource bundle:</p>
<pre class="prettyprint"><code>temperature.outside.limits = Temperature is outside acceptable limits, while it needs to be between {0} and {1} for user: {2}</code></pre>
<p>Model definition:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Temperature <span class="kw">extends</span> Model{
   <span class="dt">static</span>{
      <span class="fu">validateRange</span>(<span class="st">&quot;temp&quot;</span>, <span class="dv">10</span>, <span class="dv">2000</span>).<span class="fu">message</span>(<span class="st">&quot;temperature.outside.limits&quot;</span>);
   }
}</code></pre></td></tr></table></div>
<p>As you can see, the message calls for three parameters, but the validator can only set two. At the time of Model definition, the user is not known. However, the user can be provided when the validation fails, and an application calls for an error message:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode java">Temperature temp = <span class="kw">new</span> <span class="fu">Temperature</span>();
temp.<span class="fu">set</span>(<span class="st">&quot;temp&quot;</span>, <span class="dv">5000</span>);

<span class="kw">if</span>(!temp.<span class="fu">save</span>()){
   String message = temp.<span class="fu">errors</span>().<span class="fu">get</span>(<span class="st">&quot;temp&quot;</span>, user.<span class="fu">getName</span>());
   System.<span class="fu">out</span>.<span class="fu">println</span>(message);<span class="co">// prints: Temperature is outside acceptable limits, while it needs to be between 10 and 2000 for user: Tom</span>
}</code></pre></td></tr></table></div>
<p>The getter method for Errors class has this signature: <code>get(String attributeName, Object ... params)</code>, which allows to supply more than one parameter.</p>
<p>The one rule you have to keep in mind, is that static parameters will be indexed from zero, and dynamic parameters will be appended to static. As in this case, the user name is placed in the message at index {2}.</p>
<h2 id="internationalization-of-validation-messages-i18n">Internationalization of validation messages (I18N)</h2>
<p>In cases where there is a need for internationalization of messages, this is easy to accomplish by providing a locale instance to the <code>errors()</code> method. But first, you will need to create these messages. ActiveJDBC uses a resource bundle <code>activejdbc_messages</code>. This means:</p>
<ul>
<li><code>activejdbc_messages.properties</code> - default locale bundle</li>
<li><code>activejdbc_messages_de_DE.properties</code> - German/Germany bundle</li>
<li>etc.</li>
</ul>
<p>As usual in Java you will need to create a bundle for each locale. If you need a localized message during runtime, all you need it to provide a locale to the <code>errors()</code> method of a model. Building on the example above with temperature, the German local bundle file will have this:</p>
<pre class="prettyprint"><code>temperature.outside.limits = Die Temperatur liegt außerhalb akzeptabler Grenzen, während es sein muss zwischen {0} und {1}</code></pre>
<p>At run time, the message will be printed in German if a locale provided is German:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
</pre></td><td class="sourceCode"><pre><code class="sourceCode java">Temperature temp = <span class="kw">new</span> <span class="fu">Temperature</span>();
temp.<span class="fu">set</span>(<span class="st">&quot;temp&quot;</span>, <span class="dv">5000</span>);

<span class="kw">if</span>(!temp.<span class="fu">save</span>()){
   String message = temp.<span class="fu">errors</span>(<span class="kw">new</span> Locale(<span class="st">&quot;de&quot;</span>, <span class="st">&quot;DE&quot;</span>)).<span class="fu">get</span>(temp); <span class="co">//&lt;&lt;&lt;=== provide locale</span>
   System.<span class="fu">out</span>.<span class="fu">println</span>(message);<span class="co">// prints: Die Temperatur liegt außerhalb akzeptabler Grenzen, während es sein muss zwischen 10 und 2000</span>
}</code></pre></td></tr></table></div>
