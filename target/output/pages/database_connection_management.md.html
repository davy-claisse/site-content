<div class="page-header">
<h1>
Database connection management
</h1>
</div>
<p>ActiveJDBC provides two classes for connection management: <a href="http://javalite.github.io/activejdbc/org/javalite/activejdbc/Base.html">Base.java</a> and <a href="http://javalite.github.io/activejdbc/snapshot/org/javalite/activejdbc/DB.html">DB.java</a>.</p>
<h2 id="thread-connection-propagation">Thread connection propagation</h2>
<p>ActiveJDBC models when operate, utilize a connection found on a current thread. This connection is put on the local thread by Base or DB class before any DB operation. This approach allows for more concise API where there is no need for DB Session or persistent managers as in other Java ORMs.</p>
<p>Here is a simple program:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span>(String[] args) {
   Base.<span class="fu">open</span>(<span class="st">&quot;com.mysql.jdbc.Driver&quot;</span>, <span class="st">&quot;jdbc:mysql://localhost/test&quot;</span>, <span class="st">&quot;the_user&quot;</span>, <span class="st">&quot;the_password&quot;</span>);
   Employee.<span class="fu">findAll</span>().<span class="fu">dump</span>();
   Base.<span class="fu">close</span>();
}</code></pre></td></tr></table></div>
<p>On line 2, class Base will open a new connection and attach it to the current thread. This connection will also be marked with name &quot;default&quot;.</p>
<p>On line 3, connection is looked up from the thread and used by the model(and result dumped to STDIO)</p>
<p>On line 4, connection is closed and cleared from thread.</p>
<h2 id="database-names">Database names</h2>
<p>ActiveJDBC has a concept of a logical &quot;database&quot;. However, an application can be connected to multiple databases at the same time. In this case, ActiveJDBC allows for assigning different logical names to different databases.</p>
<p>For example, one might have an Oracle database with accounting data, and a MySQL database with inventory control data. In this case, you might want to have an &quot;accounting&quot; database and an &quot;inventory&quot; database as logical names assigned to these databases.</p>
<h2 id="db-and-base-classes">DB and Base classes</h2>
<p>Opening and closing connections is done with classes Base or DB. The DB class is used in cases where you have more than one database in the system, such as &quot;accounting&quot; and &quot;inventory&quot;.</p>
<p>Example:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">new</span> <span class="fu">DB</span>(<span class="st">&quot;inventory&quot;</span>).<span class="fu">open</span>(<span class="st">&quot;com.mysql.jdbc.Driver&quot;</span>, <span class="st">&quot;jdbc:mysql://localhost/test&quot;</span>, <span class="st">&quot;dbuser&quot;</span>, <span class="st">&quot;...&quot;</span>);</code></pre></td></tr></table></div>
<p>In this code example, there is a database connection opened, and attached to a local thread under name &quot;inventory&quot;.</p>
<p>The classes Base and DB mirror one another, having exactly the same APIs, except:</p>
<ul>
<li>All methods on DB are instance methods, while all methods on class Base are static ones.</li>
<li>class DB constructor accepts a DB name, while Base always operates with DB name: &quot;default&quot;</li>
</ul>
<p>This means that these lines are equivalent:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">new</span> <span class="fu">DB</span>(<span class="st">&quot;default&quot;</span>).<span class="fu">open</span>(<span class="st">&quot;com.mysql.jdbc.Driver&quot;</span>, <span class="st">&quot;jdbc:mysql://localhost/test&quot;</span>, <span class="st">&quot;root&quot;</span>, <span class="st">&quot;p@ssw0rd&quot;</span>);</code></pre></td></tr></table></div>
<p>and:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode java">Base.<span class="fu">open</span>(<span class="st">&quot;com.mysql.jdbc.Driver&quot;</span>, <span class="st">&quot;jdbc:mysql://localhost/test&quot;</span>, <span class="st">&quot;root&quot;</span>, <span class="st">&quot;p@ssw0rd&quot;</span>);</code></pre></td></tr></table></div>
<blockquote>
<p>Use <code>Base</code> class if you have only one database in the system, otherwise, use <code>DB</code>.</p>
</blockquote>
<h2 id="use-try-with-resources">Use Try-with-resources</h2>
<p>You can use the try-with-resources to automatically close a connection regardless if your code causes exception or not:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">try</span>(DB db = <span class="kw">new</span> <span class="fu">DB</span>()){
  db.<span class="fu">open</span>();
  <span class="co">// your code here</span>
}</code></pre></td></tr></table></div>
<h2 id="models-associated-with-multiple-databases">Models associated with multiple databases</h2>
<p>ActiveJDBC allows to have a mix of models in the application representing tables from different databases. By default a model belongs to a database &quot;default&quot;, but an association of a model to a database can be overriden with annotation <code>@DbName</code>:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="fu">@DbName</span>(<span class="st">&quot;corporation&quot;</span>)
<span class="kw">public</span> <span class="kw">class</span> Employee <span class="kw">extends</span> Model {}</code></pre></td></tr></table></div>
<h2 id="multiple-database-example">Multiple database example</h2>
<p>See sources here: <a href="https://github.com/javalite/multiple-db-example">multimple-db-example</a>.</p>
<p>For this example, we will have two models, one representing a table in Oracle database, while the other in MySQL</p>
<p>The two models are defined like this:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="fu">@DbName</span>(<span class="st">&quot;corporation&quot;</span>)
<span class="kw">public</span> <span class="kw">class</span> Employee <span class="kw">extends</span> Model {}</code></pre></td></tr></table></div>
<p>and:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="fu">@DbName</span>(<span class="st">&quot;university&quot;</span>)
<span class="kw">public</span> <span class="kw">class</span> Student  <span class="kw">extends</span> Model {}</code></pre></td></tr></table></div>
<p>and the main class looks like this:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Main {
    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span>(String[] args) {
        <span class="kw">new</span> <span class="fu">DB</span>(<span class="st">&quot;corporation&quot;</span>).<span class="fu">open</span>(<span class="st">&quot;com.mysql.jdbc.Driver&quot;</span>, <span class="st">&quot;jdbc:mysql://localhost/test&quot;</span>, <span class="st">&quot;root&quot;</span>, <span class="st">&quot;p@ssw0rd&quot;</span>);
        <span class="kw">new</span> <span class="fu">DB</span>(<span class="st">&quot;university&quot;</span>).<span class="fu">open</span>(<span class="st">&quot;oracle.jdbc.driver.OracleDriver&quot;</span>, <span class="st">&quot;jdbc:oracle:thin:@localhost:1521:xe&quot;</span>, <span class="st">&quot;activejdbc&quot;</span>, <span class="st">&quot;activejdbc&quot;</span>);

        Employee.<span class="fu">deleteAll</span>();
        Student.<span class="fu">deleteAll</span>();

        Employee.<span class="fu">createIt</span>(<span class="st">&quot;first_name&quot;</span>, <span class="st">&quot;John&quot;</span>, <span class="st">&quot;last_name&quot;</span>, <span class="st">&quot;Doe&quot;</span>);
        Employee.<span class="fu">createIt</span>(<span class="st">&quot;first_name&quot;</span>, <span class="st">&quot;Jane&quot;</span>, <span class="st">&quot;last_name&quot;</span>, <span class="st">&quot;Smith&quot;</span>);

        Student.<span class="fu">createIt</span>(<span class="st">&quot;first_name&quot;</span>, <span class="st">&quot;Mike&quot;</span>, <span class="st">&quot;last_name&quot;</span>, <span class="st">&quot;Myers&quot;</span>);
        Student.<span class="fu">createIt</span>(<span class="st">&quot;first_name&quot;</span>, <span class="st">&quot;Steven&quot;</span>, <span class="st">&quot;last_name&quot;</span>, <span class="st">&quot;Spielberg&quot;</span>);

        System.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;*** Employees ***&quot;</span>);
        Employee.<span class="fu">findAll</span>().<span class="fu">dump</span>();
        System.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;*** Students ***&quot;</span>);
        Student.<span class="fu">findAll</span>().<span class="fu">dump</span>();

        <span class="kw">new</span> <span class="fu">DB</span>(<span class="st">&quot;corporation&quot;</span>).<span class="fu">close</span>();
        <span class="kw">new</span> <span class="fu">DB</span>(<span class="st">&quot;university&quot;</span>).<span class="fu">close</span>();
    }
}</code></pre></td></tr></table></div>
<p>At the start of this app the two named connections are opened, then we proceed to use the models associated with these connections. At the end of the app, the two named connections are closed. The class DB is lightweight, and it is OK not to retain a reference to it, but rather to create a new instance each time. If you do want to retain a reference, there is no harm done though.</p>
<h2 id="database-connection-pools">Database connection pools</h2>
<p>ActiveJDBC does not maintain connection pools and does not integrate with any pools. Instead, it provides a few <code>DB.open()</code> and <code>Base.open()</code> methods to open connections. If a version of methods used that takes standard JDBC parameters, then no pool is used this is only a convenience method to open a brand new connection, such as:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode java">Base.<span class="fu">open</span>(<span class="st">&quot;com.mysql.jdbc.Driver&quot;</span>, <span class="st">&quot;jdbc:mysql://localhost/test&quot;</span>, <span class="st">&quot;root&quot;</span>, <span class="st">&quot;pwd&quot;</span>);</code></pre></td></tr></table></div>
<p>If however, this call is used:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode java">Base.<span class="fu">open</span>(<span class="st">&quot;java:comp/env/jdbc/testdb&quot;</span>);</code></pre></td></tr></table></div>
<p>it will use a JDNI name to lookup a connection. Usually this is called from within a container and the name points to a pooled JNDI DataSource.</p>
<p>If you want to work directly with some connection pool, you can do so by feeding a datasource to Base/DB class:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">new</span> <span class="fu">DB</span>(<span class="st">&quot;default&quot;</span>).<span class="fu">open</span>(datasourceInstance);</code></pre></td></tr></table></div>
<h2 id="multiple-environments-property-file-method">Multiple environments (property file method)</h2>
<p>The easiest way to configure multiple connections for different environments is to use a property file. By convention, this file is called <code>database.properties</code> and located at the root of classpath.</p>
<p>Here is an example of such a file:</p>
<pre><code>development.driver=com.mysql.jdbc.Driver
development.username=user1
development.password=pwd
development.url=jdbc:mysql://localhost/acme_development

test.driver=com.mysql.jdbc.Driver
test.username=user2
test.password=pwd
test.url=jdbc:mysql://localhost/acme_test

production.jndi=java:comp/env/jdbc/acme
</code></pre>
<p>In order for this to work, you need to configure an environment variable <code>ACTIVE_ENV</code> to a value that is equal to a property set key. According to a file above, the <code>ACTIVE_ENV</code> can take on values <code>development</code> and <code>production</code>. The <code>test</code> is special because it is used in development environment, but for running tests.</p>
<p>Once the file is configured and placed at the root of classpath, you would open connections with a no-argument method like this:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">new</span> <span class="fu">DB</span>(<span class="st">&quot;default&quot;</span>).<span class="fu">open</span>();</code></pre></td></tr></table></div>
<p>A configuration related to the current environment will be selected and used to open a connection. This makes it easy to develop applications that live on different environments, and simply &quot;know&quot; where to connect on each.</p>
<blockquote>
<p>If environment variable <code>ACTIVE_ENV</code> is not defined, the framework defaults to environment <code>development</code>.</p>
</blockquote>
<h2 id="location-of-property-file">Location of property file</h2>
<h3 id="using-system-property">Using system property</h3>
<p>You can tell the framework the location of the file by supplying a system property at the start of your program:</p>
<pre><code>java com.company.project.Main -cp myprogram.jar -Denv.connections.file=/path/to/file/database.properties</code></pre>
<p>Even if you have <code>database.properties</code> packaged into your Jar/war file, this setting will override the packaged file. Use it for production environments where database passwords cannot be checked into source control.</p>
<h3 id="using-activejdbc.properties">Using <code>activejdbc.properties</code></h3>
<p>In some cases it is inconvenient to bundle the <code>database.properties</code> file with class files on classpath. There can be different reasons for it: you want to be able to change passwords, do not want to commit credentials to code repoository, etc.</p>
<p>The database connection properties file can be given any name and can reside on a file system somewhere.</p>
<p>Here is how to configure:</p>
<p>Add a file <code>activejdbc.properties</code> to your project at root of classpath and configure a property in it:</p>
<pre><code>env.connections.file=/etc/my_project123/database.properties</code></pre>
<p>Then, simply add connection properties to the file as usual. The methods <code>DB.open()</code> and <code>Base.open()</code> will locate a connection from this file using the usual <code>ACTIVE_ENV</code> conventions.</p>
<h2 id="environment-variables-override">Environment variables override</h2>
<p>In some cases you will need to specify parameters as environment variables. This may happen on cloud based-environments such as Heroku, Jenkins CI, etc. If you use direct JDBC parameters, there are 4 environments variables you can use:</p>
<pre><code>ACTIVEJDBC.URL
ACTIVEJDBC.USER
ACTIVEJDBC.PASSWORD
ACTIVEJDBC.DRIVER</code></pre>
<p>If you use JNDI connection, you can use 1 environment variable:</p>
<pre><code>ACTIVEJDBC.JNDI</code></pre>
<p>These are self-explanatory JDBC connection parameters.</p>
<blockquote>
<p>Environment variable - based parameters will override any configuration provided in the <code>database.properties</code> file for current environment.</p>
</blockquote>
<h2 id="system-properties-override">System properties override</h2>
<p>In some cases you will need to specify connection parameters as JVM system properties. If you are using standard JDBC parameters, there are 4 system properties you can use:</p>
<pre><code>activejdbc.url
activejdbc.user
activejdbc.password
activejdbc.driver</code></pre>
<p>If you are using JNDI, the system property is:</p>
<pre><code>activejdbc.jndi</code></pre>
<blockquote>
<p>System properties - based configuration will override any configuration provided as environment variables as well as by the <code>database.properties</code> file for current environment.</p>
</blockquote>
<h2 id="specifying-db-schema">Specifying DB Schema</h2>
<p>In most cases you do not need to worry about this. However, for Oracle and PostgreSQL, some schema elements may leak into your account if a schema is not specified. If you find that your model for instance has an attribute(column) that is not part of this table description, it means that the DB mixed in this column from another table (public schema) that has the same name as your table.</p>
<p>In a case like this, you need to specify a schema for a database. If you use a default database, simply add this system property:</p>
<pre class="prettyprint"><code>-Dactivejdbc.default.schema=myschema</code></pre>
<p>where &quot;default&quot; is a name of a database and &quot;myschema&quot; is a name of your schema in Oracle or PostgreSQL.</p>
<p>In case you do use multiple connections to different databases and you use DbName annotation, replace &quot;default&quot; to your DB name. For example:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="fu">@DbName</span>(<span class="st">&quot;university&quot;</span>)
<span class="kw">public</span> <span class="kw">class</span> Student <span class="kw">extends</span> Model{}</code></pre></td></tr></table></div>
<p>then you can add a property like this:</p>
<pre class="prettyprint"><code>-Dactivejdbc.university.schema=myschema</code></pre>
<blockquote>
<p>The schema specification is used in order to retrive metadata for tables at start time, and not used in generating queries.</p>
</blockquote>
