<div class="page-header">
<h1>
Deploying to heroku
</h1>
</div>
<p>This guide uses the ClearDB mysql service, but it could easily be adapted to the Heroku Postgres service.</p>
<p>FYI: its completely possible that I forgot something in this guide and that it will need to be updated by the very first person that tries to use it. Post something on the GoogleGroup if you need help.</p>
<p>The basic idea is that Heroku puts a specific environment variables in your apps config that you need to be able to read at runtime to setup your db connections. Try this command in your Heroku toolbelt to see your current config vars. You might see something like this:</p>
<pre class="prettyprint"><code>~&gt; heroku config
=== your app Config Vars

CLEARDB_DATABASE_URL: mysql://zzzzzz@us-cdbr-east-03.cleardb.com/heroku_yyyyyy?reconnect=true
DATABASE_URL:         mysql://zzzzzz@us-cdbr-east-03.cleardb.com/heroku_yyyyyy?reconnect=true
SENDGRID_PASSWORD:    PPPPPPP
SENDGRID_USERNAME:    UUUUUU@heroku.com</code></pre>
<h2 id="database-url">Database URL</h2>
<p>The recommended practice by Heroku is to have the full database url in an environment variable named DATABASE_URL. By default ClearDB puts the URL in a different var (shown above) and you have to copy the value into a new var with this name. Try this to learn about setting up config vars</p>
<pre class="prettyprint"><code>heroku help config</code></pre>
<h2 id="at-runtime">At runtime</h2>
<p>Your next task is to be able to read this variable at runtime. Here's a class and its spec for the Utility that I use to do so</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">package app.utils;</span>
<span class="kw">import org.junit.Test;</span>
<span class="kw">import java.net.URISyntaxException;</span>
<span class="kw">import java.util.HashMap;</span>
<span class="kw">import java.util.Map;</span>
<span class="kw">import java.util.Properties;</span>
<span class="kw">import static org.javalite.test.jspec.JSpec.the;</span>
<span class="co">/**</span>
<span class="co"> * Created By</span>
<span class="co"> * User: Evan Leonard</span>
<span class="co"> * Date: 3/30/13</span>
<span class="co"> */</span>
<span class="kw">public</span> <span class="kw">class</span> HerokuDbUrlParserSpec {
    <span class="kw">private</span> <span class="dt">static</span> String clear_db_url = <span class="st">&quot;mysql://THE_USERNAME:THE_PASSWORD@us-cdbr-east-03.cleardb.com/heroku_759ea2a30074fe9?reconnect=true&quot;</span>;
    <span class="co">//private static String test_db_url = &quot;mysql://aw:awawaw@localhost/ayah_test?reconnect=true&quot;;</span>
    <span class="fu">@Test</span>
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">shouldParseUrl</span>() <span class="kw">throws</span> URISyntaxException {
        Map&lt;String, String&gt; mockEnv = <span class="fu">mockEnv</span>();
        HerokuDbUrlParser herokuDbUrlParser = <span class="kw">new</span> <span class="fu">HerokuDbUrlParser</span>(mockEnv);
        Properties jdbcProperties = herokuDbUrlParser.<span class="fu">getJdbcProperties</span>();
        <span class="fu">the</span>(jdbcProperties.<span class="fu">getProperty</span>(<span class="st">&quot;driver&quot;</span>)).<span class="fu">shouldEqual</span>(<span class="st">&quot;com.mysql.jdbc.Driver&quot;</span>);
        <span class="fu">the</span>(jdbcProperties.<span class="fu">getProperty</span>(<span class="st">&quot;url&quot;</span>)).<span class="fu">shouldEqual</span>(<span class="st">&quot;jdbc:mysql://us-cdbr-east-03.cleardb.com/heroku_759ea2a30074fe9?reconnect=true&quot;</span>);
        <span class="fu">the</span>(jdbcProperties.<span class="fu">getProperty</span>(<span class="st">&quot;user&quot;</span>)).<span class="fu">shouldEqual</span>(<span class="st">&quot;THE_USERNAME&quot;</span>);
        <span class="fu">the</span>(jdbcProperties.<span class="fu">getProperty</span>(<span class="st">&quot;password&quot;</span>)).<span class="fu">shouldEqual</span>(<span class="st">&quot;THE_PASSWORD&quot;</span>);
        <span class="fu">the</span>(herokuDbUrlParser.<span class="fu">getDriver</span>()).<span class="fu">shouldEqual</span>(<span class="st">&quot;com.mysql.jdbc.Driver&quot;</span>);
        <span class="fu">the</span>(herokuDbUrlParser.<span class="fu">getUrl</span>()).<span class="fu">shouldEqual</span>(<span class="st">&quot;jdbc:mysql://us-cdbr-east-03.cleardb.com/heroku_759ea2a30074fe9?reconnect=true&quot;</span>);
        <span class="fu">the</span>(herokuDbUrlParser.<span class="fu">getUser</span>()).<span class="fu">shouldEqual</span>(<span class="st">&quot;THE_USERNAME&quot;</span>);
        <span class="fu">the</span>(herokuDbUrlParser.<span class="fu">getPassword</span>()).<span class="fu">shouldEqual</span>(<span class="st">&quot;THE_PASSWORD&quot;</span>);
    }
    <span class="kw">private</span> Map&lt;String, String&gt; <span class="fu">mockEnv</span>() {
        Map&lt;String, String&gt; mockEnv = <span class="kw">new</span> HashMap&lt;String, String&gt;();
        mockEnv.<span class="fu">put</span>(<span class="st">&quot;DATABASE_URL&quot;</span>, clear_db_url);
        <span class="kw">return</span> mockEnv;
    }
}</code></pre></td></tr></table></div>
<p>And the implementation:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">package app.utils;</span>
<span class="kw">import org.slf4j.Logger;</span>
<span class="kw">import org.slf4j.LoggerFactory;</span>
<span class="kw">import sun.reflect.generics.reflectiveObjects.NotImplementedException;</span>
<span class="kw">import java.net.URI;</span>
<span class="kw">import java.net.URISyntaxException;</span>
<span class="kw">import java.util.Map;</span>
<span class="kw">import java.util.Properties;</span>
<span class="co">/**</span>
<span class="co"> * Created By</span>
<span class="co"> * User: evan</span>
<span class="co"> * Date: 3/27/13</span>
<span class="co"> *</span>
<span class="co"> * Heroku sets the production database url into an environment variable named DATABASE_URL.</span>
<span class="co"> *</span>
<span class="co"> * This class is parses that at runtime for ActiveWeb to use in DbConfig.java</span>
<span class="co"> */</span>
<span class="kw">public</span> <span class="kw">class</span> HerokuDbUrlParser {
    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> Logger logger = LoggerFactory.<span class="fu">getLogger</span>(HerokuDbUrlParser.<span class="fu">class</span>);
    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> String DATABASE_URL = <span class="st">&quot;DATABASE_URL&quot;</span>;
    <span class="kw">private</span> <span class="dt">boolean</span> databaseUrlFound = <span class="kw">false</span>;
    <span class="kw">private</span> String driver;
    <span class="kw">private</span> String user;
    <span class="kw">private</span> String password;
    <span class="kw">private</span> String url;

    <span class="kw">public</span> <span class="fu">HerokuDbUrlParser</span>(Map&lt;String, String&gt; environmentVariables) {
        String database_url = <span class="fu">getHerokuDatabaseUrl</span>(environmentVariables);
        <span class="kw">if</span>(database_url != <span class="kw">null</span>) {
            databaseUrlFound = <span class="kw">true</span>;
            <span class="kw">if</span> (logger.<span class="fu">isInfoEnabled</span>()) logger.<span class="fu">info</span>(<span class="st">&quot;Found DATABASE_URL: &quot;</span>+database_url);
            <span class="fu">parseDatabaseUrl</span>(database_url);
        }
        <span class="kw">else</span> {
            <span class="kw">if</span> (logger.<span class="fu">isInfoEnabled</span>()) logger.<span class="fu">info</span>(<span class="st">&quot;DID NOT FIND DATABASE_URL ENV VARIABLE!&quot;</span>);
        }
    }

    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">parseDatabaseUrl</span>(String database_url) {
        <span class="kw">try</span> {
            URI dbUri = <span class="kw">new</span> URI(database_url);
            driver = <span class="fu">inferDriverClass</span>(database_url);
            user = dbUri.<span class="fu">getUserInfo</span>().<span class="fu">split</span>(<span class="st">&quot;:&quot;</span>)[<span class="dv">0</span>];
            password = dbUri.<span class="fu">getUserInfo</span>().<span class="fu">split</span>(<span class="st">&quot;:&quot;</span>)[<span class="dv">1</span>];
            String authPart = user + <span class="st">&quot;:&quot;</span> + password + <span class="st">&quot;@&quot;</span>;
            url = <span class="st">&quot;jdbc:&quot;</span>+database_url.<span class="fu">replace</span>(authPart, <span class="st">&quot;&quot;</span>);
        } <span class="kw">catch</span> (URISyntaxException e) {
            logger.<span class="fu">error</span>(<span class="st">&quot;Failed to parse Heroku DB Url&quot;</span>, e);
            driver = url = user = password = <span class="kw">null</span>;
            <span class="kw">throw</span> <span class="kw">new</span> RuntimeException(<span class="st">&quot;Failed to parse Heroku DB Url&quot;</span>,e);
        }
    }

    <span class="kw">private</span> <span class="dt">static</span> String <span class="fu">getHerokuDatabaseUrl</span>(Map&lt;String, String&gt; environmentVariables) {
        String database_url = environmentVariables.<span class="fu">get</span>(DATABASE_URL);
        <span class="kw">if</span>(database_url != <span class="kw">null</span>) {
            logger.<span class="fu">error</span>(<span class="st">&quot;FOUND DB URL IN ENVIRONMENT VARIABLES&quot;</span>);
        }
        <span class="kw">else</span> {
            database_url = System.<span class="fu">getProperty</span>(DATABASE_URL);
            <span class="kw">if</span>(database_url != <span class="kw">null</span>){
                logger.<span class="fu">error</span>(<span class="st">&quot;FOUND DB URL IN SYSTEM PROPERTIES&quot;</span>);
            }
        }
        <span class="kw">return</span> database_url;
    }

    <span class="kw">private</span> <span class="dt">static</span> String <span class="fu">inferDriverClass</span>(String database_url) {
        String driver;
        <span class="kw">if</span>(database_url.<span class="fu">contains</span>(<span class="st">&quot;mysql&quot;</span>)) {
            driver = <span class="st">&quot;com.mysql.jdbc.Driver&quot;</span>;
        }
        <span class="kw">else</span> {
            <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">NotImplementedException</span>();
        }
        <span class="kw">return</span> driver;
    }

    <span class="kw">public</span> String <span class="fu">getDriver</span>() {
        <span class="kw">return</span> driver;
    }

    <span class="kw">public</span> String <span class="fu">getUrl</span>() {
        <span class="kw">return</span> url;
    }

    <span class="kw">public</span> String <span class="fu">getUser</span>() {
        <span class="kw">return</span> user;
    }

    <span class="kw">public</span> String <span class="fu">getPassword</span>() {
        <span class="kw">return</span> password;
    }

    <span class="co">/**</span>
<span class="co">     * </span><span class="kw">@return </span><span class="co">Property set that contains: &#39;driver&#39;, &#39;url&#39;, &#39;user&#39;, and &#39;password&#39; with no prefix</span>
<span class="co">     */</span>
    <span class="kw">public</span> Properties <span class="fu">getJdbcProperties</span>() {
        <span class="kw">if</span>(!databaseUrlFound) {
            <span class="kw">return</span> <span class="kw">null</span>;
        }

        String driver = <span class="fu">getDriver</span>();
        String url = <span class="fu">getUrl</span>();
        String user = <span class="fu">getUser</span>();
        String password = <span class="fu">getPassword</span>();

        Properties properties = <span class="kw">new</span> Properties();
        properties.<span class="fu">setProperty</span>(<span class="st">&quot;driver&quot;</span>, driver);
        properties.<span class="fu">setProperty</span>(<span class="st">&quot;url&quot;</span>, url);
        properties.<span class="fu">setProperty</span>(<span class="st">&quot;user&quot;</span>, user);
        properties.<span class="fu">setProperty</span>(<span class="st">&quot;password&quot;</span>, password);

        <span class="kw">return</span> properties;
    }
}</code></pre></td></tr></table></div>
<p>With that in place you call this use this method in your DbConfig with &quot;production&quot; and the jdbcProperties returned by the parser above to setup your ActiveJdbc connection</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="kw">private</span> <span class="dt">void</span> <span class="fu">createConnection</span>(String env, Properties jdbcProperties) {
    String driver = jdbcProperties.<span class="fu">getProperty</span>(<span class="st">&quot;driver&quot;</span>);
    String url = jdbcProperties.<span class="fu">getProperty</span>(<span class="st">&quot;url&quot;</span>);
    <span class="fu">environment</span>(env).<span class="fu">jdbc</span>(driver, url, jdbcProperties);
    <span class="fu">environment</span>(env).<span class="fu">testing</span>().<span class="fu">jdbc</span>(driver, url, jdbcProperties);
}</code></pre></td></tr></table></div>
<h2 id="building-on-heroku">Building on Heroku</h2>
<p>Heroku of course will try to build your app as soon as you push its git repo. It does a good job of detecting that its a Java app and running maven. Where I ran into trouble was that I had configured my POM to do different things based on the value of the ACTIVE_ENV environment variable. Even thought I could set a config var of that name, <strong>config vars are not available at build time</strong></p>
<p>The approach I found was to fork the heroku java build pack and hardcode -DACTIVE_ENV=production into the java properties used to run maven. Here is the location of my forked buildpack:</p>
<pre class="prettyprint"><code>https://github.com/evanleonard/heroku-buildpack-java</code></pre>
<p>To have your app use it to if you want, you just set a config var like this:</p>
<pre class="prettyprint"><code>BUILDPACK_URL:        https://github.com/evanleonard/heroku-buildpack-java</code></pre>
<blockquote>
<p>Note: after my first successful build I noticed that these config vars appeared. It may be possible to modify them to eliminate the need for this custom build pack. But I haven't tried to do this yet.</p>
</blockquote>
<pre class="prettyprint"><code>JAVA_OPTS:            -Xmx384m -Xss512k -XX:+UseCompressedOops
MAVEN_OPTS:           -Xmx384m -Xss512k -XX:+UseCompressedOops</code></pre>
<h2 id="disabling-tests">Disabling Tests</h2>
<p>Also had to disable running of Selenium tests in my POM.</p>
<p>TODO</p>
<h2 id="heroku-ssl-support">Heroku SSL support</h2>
<p>There's two things you need to do after you've enabled your SSL endpoint add-on in heroku. The first is to force traffic from regular http to https. This is easily done in a filter with methods like these</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="sourceCode"><pre><code class="sourceCode java"><span class="co">/**</span>
<span class="co"> * http://stackoverflow.com/questions/7185074/heroku-nodejs-http-to-https-ssl-forced-redirect</span>
<span class="co"> */</span>
<span class="kw">private</span> <span class="dt">boolean</span> <span class="fu">isHttpsRequest</span>() {
    String header = <span class="fu">header</span>(<span class="st">&quot;x-forwarded-proto&quot;</span>);
    <span class="kw">return</span> header != <span class="kw">null</span> &amp;&amp; header.<span class="fu">equals</span>(<span class="st">&quot;https&quot;</span>);
}
<span class="kw">private</span> <span class="dt">void</span> <span class="fu">redirectToHttps</span>() {
    <span class="fu">flash</span>(Constants.<span class="fu">PJAX_FORCE_RELOAD</span>, <span class="kw">true</span>);
    StringBuilder newUrl = <span class="fu">getHttpsUrl</span>();
    <span class="fu">redirect</span>(newUrl.<span class="fu">toString</span>());
}</code></pre></td></tr></table></div>
<p>The next is to rewrite incoming requests so they appear as though they came straight from the client, eventhough they've been routed through the SSL endpoint. The best way I found to do this was with the XForwardedFilter from Xebia. To enable put this in your pom:</p>
<div class="sourceCode"><table class="sourceCode xml numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
</pre></td><td class="sourceCode"><pre><code class="sourceCode xml"><span class="kw">&lt;dependency&gt;</span>
    <span class="kw">&lt;groupId&gt;</span>fr.xebia.web<span class="kw">&lt;/groupId&gt;</span>
    <span class="kw">&lt;artifactId&gt;</span>xebia-servlet-extras<span class="kw">&lt;/artifactId&gt;</span>
    <span class="kw">&lt;version&gt;</span>1.0.8<span class="kw">&lt;/version&gt;</span>
<span class="kw">&lt;/dependency&gt;</span></code></pre></td></tr></table></div>
<p>and then add this to your web.xml above the dispatcher's filter-mapping:</p>
<div class="sourceCode"><table class="sourceCode xml numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="sourceCode"><pre><code class="sourceCode xml"><span class="kw">&lt;filter&gt;</span>
    <span class="kw">&lt;filter-name&gt;</span>XForwardedFilter<span class="kw">&lt;/filter-name&gt;</span>
    <span class="kw">&lt;filter-class&gt;</span>fr.xebia.servlet.filter.XForwardedFilter<span class="kw">&lt;/filter-class&gt;</span>
    <span class="kw">&lt;init-param&gt;</span>
        <span class="kw">&lt;param-name&gt;</span>protocolHeader<span class="kw">&lt;/param-name&gt;</span>
        <span class="kw">&lt;param-value&gt;</span>x-forwarded-proto<span class="kw">&lt;/param-value&gt;</span>
    <span class="kw">&lt;/init-param&gt;</span>
<span class="kw">&lt;/filter&gt;</span>

<span class="co">&lt;!-- This must be before the dispatcher so that it is executed first in the filter chain --&gt;</span>
<span class="kw">&lt;filter-mapping&gt;</span>
    <span class="kw">&lt;filter-name&gt;</span>XForwardedFilter<span class="kw">&lt;/filter-name&gt;</span>
    <span class="kw">&lt;url-pattern&gt;</span>/*<span class="kw">&lt;/url-pattern&gt;</span>
    <span class="kw">&lt;dispatcher&gt;</span>REQUEST<span class="kw">&lt;/dispatcher&gt;</span>
<span class="kw">&lt;/filter-mapping&gt;</span></code></pre></td></tr></table></div>
<h2 id="summary">Summary</h2>
<p>That should be it, go ahead and push to your git repo, let Heroku do its thing and see if you get a new build live on the web. Then enjoy continuous deployment!</p>
<p>Oh, and please post something on the GoogleGroup if (when?) you run into a problem. As I said at the start, its very likely I missed something here.</p>
<p>Best Evan</p>
