<div class="page-header">
<h1>
Delete cascade
</h1>
</div>
<p>ActiveJDBC provides two methods for deleting with cascade: <code>deleteCascade()</code> and <code>deleteCascadeShallow()</code>.</p>
<p>Method <code>deleteCascade()</code> is deep but not high performance, while <code>deleteCascadeShallow()</code>is fast, but not deep (hence the name). Please, see below for more information.</p>
<h2 id="method-deletecascade">Method deleteCascade()</h2>
<p>ActiveJDBC class <code>Model</code> provides a method:</p>
<p>This method deletes current record from associated table, as well as children. Deletes current model and all of its child and many to many associations. This is not a high performance method, as it will load every row into a model instance before deleting, effectively calling (N + 1) per table queries to the DB, one to select all the associated records (per table), and one delete statement per record. Use it for small data sets.</p>
<p>In cases of simple one to many and polymorphic associations, things are as expected, a parent is deleted an all children are deleted as well, but in more complicated cases, this method will walk entire tree of associated tables, sometimes coming back to the same one where it all started. It will follow associations of children and their associations too; consider this a true cascade delete with all implications (circular dependencies, referential integrity constraints, potential performance bottlenecks, etc.)</p>
<p>Imagine a situation where you have <code>DOCTORS</code> and <code>PATIENTS</code> in many to many relationship (with <code>DOCTORS_PATIENTS</code> table as a join table), and in addition <code>PATIENTS</code> and <code>PRESCRIPTIONS</code> in one to many relationship, where a patient might have many prescriptions:</p>
<p><code>DOCTORS</code>:</p>
<table style="width:67%;">
<colgroup>
<col width="6%" />
<col width="18%" />
<col width="16%" />
<col width="25%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">id</th>
<th align="left">first_name</th>
<th align="left">last_name</th>
<th align="left">discipline</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><p>1</p></td>
<td align="left"><p>John</p></td>
<td align="left"><p>Kentor</p></td>
<td align="left"><p>otolaryngology</p></td>
</tr>
<tr class="even">
<td align="left"><p>2</p></td>
<td align="left"><p>Hellen</p></td>
<td align="left"><p>Hunt</p></td>
<td align="left"><p>dentistry</p></td>
</tr>
<tr class="odd">
<td align="left"><p>3</p></td>
<td align="left"><p>John</p></td>
<td align="left"><p>Druker</p></td>
<td align="left"><p>oncology</p></td>
</tr>
</tbody>
</table>
<p><code>PATIENTS</code>:</p>
<table style="width:43%;">
<colgroup>
<col width="6%" />
<col width="18%" />
<col width="18%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">id</th>
<th align="left">first_name</th>
<th align="left">last_name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><p>1</p></td>
<td align="left"><p>Jim</p></td>
<td align="left"><p>Cary</p></td>
</tr>
<tr class="even">
<td align="left"><p>2</p></td>
<td align="left"><p>John</p></td>
<td align="left"><p>Carpenter</p></td>
</tr>
<tr class="odd">
<td align="left"><p>3</p></td>
<td align="left"><p>John</p></td>
<td align="left"><p>Doe</p></td>
</tr>
</tbody>
</table>
<p><code>DOCTORS_PATIENTS</code>:</p>
<table style="width:42%;">
<colgroup>
<col width="6%" />
<col width="16%" />
<col width="18%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">id</th>
<th align="left">doctor_id</th>
<th align="left">patient_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><p>1</p></td>
<td align="left"><p>1</p></td>
<td align="left"><p>2</p></td>
</tr>
<tr class="even">
<td align="left"><p>2</p></td>
<td align="left"><p>1</p></td>
<td align="left"><p>1</p></td>
</tr>
<tr class="odd">
<td align="left"><p>3</p></td>
<td align="left"><p>2</p></td>
<td align="left"><p>1</p></td>
</tr>
<tr class="even">
<td align="left"><p>4</p></td>
<td align="left"><p>3</p></td>
<td align="left"><p>3</p></td>
</tr>
</tbody>
</table>
<p><code>PRESCRIPTIONS</code>:</p>
<table style="width:60%;">
<colgroup>
<col width="6%" />
<col width="34%" />
<col width="18%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">id</th>
<th align="left">name</th>
<th align="left">patient_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><p>1</p></td>
<td align="left"><p>Viagra</p></td>
<td align="left"><p>1</p></td>
</tr>
<tr class="even">
<td align="left"><p>2</p></td>
<td align="left"><p>Prozac</p></td>
<td align="left"><p>1</p></td>
</tr>
<tr class="odd">
<td align="left"><p>3</p></td>
<td align="left"><p>Valium</p></td>
<td align="left"><p>2</p></td>
</tr>
<tr class="even">
<td align="left"><p>4</p></td>
<td align="left"><p>Marijuana (medicinal)</p></td>
<td align="left"><p>2</p></td>
</tr>
<tr class="odd">
<td align="left"><p>5</p></td>
<td align="left"><p>CML treatment</p></td>
<td align="left"><p>3</p></td>
</tr>
</tbody>
</table>
<p>Lets start with a simple example, Doctor John Druker. This doctor has one patient John Doe, and the patient has one prescription. So, when an instance of this doctor model is issued statement:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
</pre></td><td class="sourceCode"><pre><code class="sourceCode java">drDruker.<span class="fu">deleteCascade</span>();</code></pre></td></tr></table></div>
<p>the result is as expected: the DOCTORS:ID=3 is deleted, DOCTORS_PATIENTS:ID=4 is deleted, PATIENTS:ID=3 is deleted and PRESCRIPTIONS:ID=5 is deleted.</p>
<p>However, when doctor Kentor(#1) is deleted, the results are devastating. The following records are also deleted:</p>
<p>DOCTORS_PATIENTS:ID=1, 2 - these are links to patients PATIENTS:ID=1,2 these are patients themselves</p>
<p>PRESCRIPTIONS:ID=1,2,3,4 - these are prescriptions of patients 1 and 2</p>
<p>But, in addition, since this is a many to many relationship, deleting patients 1 and 2 results in also deleting doctor Hellen Hunt(#2), since she is a doctor of patient Jim Cary(#1), deleting all corresponding join links from table DOCTORS_PATIENTS. So, deleting doctor Kentor, deleted most all records from related tables, leaving only these records in place:</p>
<pre class="prettyprint"><code>DOCTORS:ID=3
DOCTORS_PATIENTS:ID=4
PATIENTS:ID=3
PRESCRIPTIONS:ID=5</code></pre>
<p>Had doctor Hellen Hunt(#2) had more patients, it would delete them too, and so on. This goes a long way to say that it could be easy to be tangled up in web of associations, so be careful out there.</p>
<blockquote>
<p>After deletion, this instance becomes <code>frozen()</code> and cannot be used anymore until <code>thaw()</code> is called.</p>
</blockquote>
<h2 id="method-deletecascadeexcept">Method deleteCascadeExcept()</h2>
<p>The method <code>deleteCascade()</code> will navigate to all relationships of a model and their relationships, etc. This can lead to some unexpected results - you might find that it deleted some important records. If this is the case, use method <code>deleteCascadeExcept(Association ... associations)</code>.</p>
<p>Lets say you have models: Article, Comment and Tag such that Article has many Comments, and Comment has many Tags.</p>
<p>This method then allows to skip some associations of a model from following:</p>
<div class="sourceCode"><table class="sourceCode java numberLines"><tr class="sourceCode"><td class="lineNumbers"><pre>1
2
</pre></td><td class="sourceCode"><pre><code class="sourceCode java">Comment comment = Comment.<span class="fu">findFirst</span>(...<span class="fu">criteria</span> ...);
comment.<span class="fu">deleteCascadeExcept</span>(Comment.<span class="fu">getMetaModel</span>().<span class="fu">getAssociationForTarget</span>(<span class="st">&quot;articles&quot;</span>));</code></pre></td></tr></table></div>
<p>In the example above, the comment will be deleted along with its tags, but the article will stay intact.</p>
<h2 id="method-deletecascadeshallow">Method deleteCascadeShallow()</h2>
<p>Deletes current record from associated table, as well as its immediate children. This is a high performance method because it does not walk through a chain of child dependencies like <code>deleteCascade()</code> does, but rather issues one DELETE statement per child dependency table. Also, its semantics are a bit different between that <code>deleteCascade()</code>. It only deletes current record and immediate children, but not their children (no grand kinds are dead as a result :)).</p>
<h3 id="one-to-many-and-polymorphic-associations-and-deletecascadeshallow">One to many and polymorphic associations and deleteCascadeShallow()</h3>
<p>The current record is deleted, as well as immediate children.</p>
<h3 id="many-to-many-associations-and-deletecascadeshallow">Many to many associations and deleteCascadeShallow()</h3>
<p>The current record is deleted, as well as links in a join table. Nothing else is deleted.</p>
